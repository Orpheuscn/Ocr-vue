<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片坐标映射工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- 引入Tailwind CSS和DaisyUI -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.6.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 自定义Tailwind类 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            },
            daisyui: {
                themes: ["light", "dark"],
            },
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: hidden;
        }
        [data-theme="dark"] .container {
            background-color: #2a303c;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        [data-theme="dark"] h1 {
            color: white;
        }
        [data-theme="dark"] h1.text-accent-focus {
            color: white !important;
        }
        .upload-section {
            margin-bottom: 20px;
            text-align: center;
        }
        #file-input {
            display: none;
        }
        .upload-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .upload-btn:hover {
            background-color: #45a049;
        }
        .canvas-container {
            margin: 0 auto;
        }
        #canvas-wrapper {
            position: relative;
            margin: 0 auto;
        }
        .info-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .coordinates {
            font-family: monospace;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .no-image {
            color: #666;
            font-style: italic;
            text-align: center;
        }
        .instructions {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        /* 十字线样式 */
        .crosshair-h, .crosshair-v {
            position: absolute;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
        .crosshair-h {
            width: 100%;
            height: 0;
            border-top: 1px dashed rgba(255, 0, 0, 0.9);
            left: 0;
        }
        .crosshair-v {
            height: 100%;
            width: 0;
            border-left: 1px dashed rgba(255, 0, 0, 0.9);
            top: 0;
        }
        /* 实时坐标显示框 */
        .coordinates-display {
            position: absolute;
            background-color: rgba(100, 100, 100, 0.85);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            z-index: 120;
            display: none;
            box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
        }
        [data-theme="dark"] .coordinates-display {
            background-color: rgba(150, 150, 150, 0.85);
            color: #000;
        }
    </style>
</head>
<body class="bg-base-200 min-h-screen">
    <div class="container mx-auto px-4 py-6 w-full max-w-full">
        <!-- 标题部分和主题切换 -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-accent-focus dark:text-white">图片坐标映射工具</h1>
            <label class="swap swap-rotate">
                <!-- 这个 checkbox 控制图标的切换 -->
                <input type="checkbox" id="theme-toggle" class="theme-controller" value="dark" />
                
                <!-- 太阳图标 -->
                <svg class="swap-on fill-current w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
                
                <!-- 月亮图标 -->
                <svg class="swap-off fill-current w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/></svg>
            </label>
        </div>
        
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- 左侧：图片上传和预览区域 -->
            <div class="lg:w-2/3 order-2 lg:order-1">
                <!-- 上传按钮 -->
                <div class="card bg-base-100 shadow-md mb-4">
                    <div class="card-body p-4 flex justify-center">
                        <input type="file" id="file-input" accept="image/*" class="hidden" />
                        <button class="btn btn-accent btn-wide" id="upload-button">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0l-4 4m4-4v12" />
                            </svg>
                            上传图片
                        </button>
                    </div>
                </div>
                
                <!-- Canvas容器 -->
                <div class="card bg-base-100 shadow-md overflow-hidden h-[70vh] lg:h-[80vh]">
                    <div id="canvas-container" class="w-full h-full flex items-center justify-center border-2 border-dashed border-base-300 rounded-box relative">
                        <div id="canvas-wrapper" class="relative overflow-visible">
                            <canvas id="canvas"></canvas>
                            <!-- 十字线元素 -->
                            <div id="crosshair-h" class="crosshair-h"></div>
                            <div id="crosshair-v" class="crosshair-v"></div>
                            <!-- 坐标显示 -->
                            <div id="coordinates-display" class="coordinates-display"></div>
                        </div>
                        <p id="no-image-text" class="text-base-content/60 italic absolute">请先上传一张图片</p>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：坐标信息 -->
            <div class="lg:w-1/3 order-1 lg:order-2 mb-4 lg:mb-0">
                <div class="card bg-base-100 shadow-md h-full">
                    <div class="card-body">
                        <h2 class="card-title text-accent">矩形坐标信息</h2>
                        <div id="display-coordinates" class="hidden"></div>
                        <div id="original-coordinates" class="space-y-4 overflow-auto max-h-[40vh] lg:max-h-[70vh]">
                            <div class="text-base-content">原图尺寸: 0 × 0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let canvas;
        let originalImageWidth = 0;
        let originalImageHeight = 0;
        let scaleX = 1;
        let scaleY = 1;
        let isDrawing = false;
        let currentRect = null;
        let rectangles = [];
        let startX = 0;
        let startY = 0;
        let rectCounter = 0;
        // 颜色管理
        let usedColors = [];
        const colorPool = [
            0, 25, 50, 75, 100, 125, 150, 175, 200, 225, 250, 275, 300, 325, 350
        ];

        // DOM 元素
        const fileInput = document.getElementById('file-input');
        const uploadButton = document.getElementById('upload-button');
        const canvasContainer = document.getElementById('canvas-container');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const noImageText = document.getElementById('no-image-text');
        const displayCoordinates = document.getElementById('display-coordinates');
        const originalCoordinates = document.getElementById('original-coordinates');
        const themeToggle = document.getElementById('theme-toggle');
        // 十字线和坐标显示元素
        const crosshairH = document.getElementById('crosshair-h');
        const crosshairV = document.getElementById('crosshair-v');
        const coordinatesDisplay = document.getElementById('coordinates-display');

        // 设置主题
        function initTheme() {
            // 检查localStorage中是否有保存的主题
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                themeToggle.checked = (savedTheme === 'dark');
            } else {
                // 检查系统偏好
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    themeToggle.checked = true;
                }
            }
        }

        // 初始化主题
        initTheme();

        // 主题切换事件监听
        themeToggle.addEventListener('change', function() {
            const theme = this.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        });

        // 全局变量
        let currentImageId = null;

        // 事件监听
        uploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', handleImageUpload);

        // 初始化
        initCanvas();

        // 初始化Canvas
        function initCanvas() {
            canvas = new fabric.Canvas('canvas', {
                selection: false,
                width: 100,
                height: 100
            });
            
            noImageText.style.display = 'block';
            canvas.wrapperEl.style.display = 'none';
        }

        // 处理图片上传
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 创建FormData对象，用于发送到后端
            const formData = new FormData();
            formData.append('file', file);
            
            // 显示加载提示
            noImageText.textContent = "正在上传并分析图片，请稍候...";
            noImageText.style.display = 'block';
            canvas.wrapperEl.style.display = 'none';
            
            // 发送到后端进行处理
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('上传失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 保存图片信息
                    currentImageId = data.image_id;
                    
                    // 加载检测结果图片
                const img = new Image();
                img.onload = () => {
                    // 保存原图尺寸
                        originalImageWidth = data.width;
                        originalImageHeight = data.height;
                    
                    // 设置Canvas尺寸
                    setupCanvas(img);
                    
                    // 加载图片到Canvas
                    loadImageToCanvas(img);
                    
                    // 启用矩形绘制
                    enableRectangleDrawing();
                    
                    // 更新UI
                    noImageText.style.display = 'none';
                    canvas.wrapperEl.style.display = 'block';
                    canvasContainer.classList.add('border-accent');
                    canvasContainer.classList.remove('border-dashed');
                    canvasContainer.classList.add('border-solid');
                    
                    // 设置十字线尺寸
                    crosshairH.style.width = canvas.width + 'px';
                    crosshairV.style.height = canvas.height + 'px';
                    
                    // 重置矩形和坐标信息
                    rectangles = [];
                    rectCounter = 0;
                        
                        // 添加检测到的矩形
                        addDetectedRectangles(data.rectangles);
                        
                        // 更新所有坐标信息
                    updateAllCoordinates();
                        
                        // 添加提交按钮
                        addSubmitButton();
                    };
                    img.src = data.original_image_url;
                } else {
                    noImageText.textContent = `错误: ${data.error || '上传失败'}`;
                    noImageText.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('上传错误:', error);
                noImageText.textContent = `错误: ${error.message}`;
                noImageText.style.display = 'block';
            });
        }
        
        // 添加检测到的矩形
        function addDetectedRectangles(detectedRects) {
            detectedRects.forEach(rectData => {
                const coords = rectData.coords;
                const topLeft = coords.topLeft;
                const bottomRight = coords.bottomRight;
                
                // 计算显示坐标
                const displayLeft = topLeft.x * scaleX;
                const displayTop = topLeft.y * scaleY;
                const displayWidth = (bottomRight.x - topLeft.x) * scaleX;
                const displayHeight = (bottomRight.y - topLeft.y) * scaleY;
                
                // 生成颜色
                const colorHue = getRandomColorHue();
                const fillColor = `hsla(${colorHue}, 80%, 60%, 0.3)`;
                const strokeColor = `hsla(${colorHue}, 80%, 60%, 0.8)`;
                
                // 创建矩形
                const rect = new fabric.Rect({
                    left: displayLeft,
                    top: displayTop,
                    width: displayWidth,
                    height: displayHeight,
                    fill: fillColor,
                    stroke: strokeColor,
                    strokeWidth: 1,
                    selectable: false
                });
                
                canvas.add(rect);
                
                // 保存矩形信息
                rectangles.push({
                    id: rectData.id,
                    rect: rect,
                    coords: calculateCoordinates(rect),
                    class: rectData.class,
                    confidence: rectData.confidence
                });
            });
            
            canvas.renderAll();
        }
        
        // 添加提交按钮
        function addSubmitButton() {
            // 检查是否已经存在提交按钮
            if (document.getElementById('submit-button')) {
                return;
            }
            
            // 创建提交按钮容器
            const submitContainer = document.createElement('div');
            submitContainer.className = "fixed bottom-4 right-4 z-50";
            
            // 创建提交按钮
            const submitButton = document.createElement('button');
            submitButton.id = 'submit-button';
            submitButton.className = "btn btn-primary shadow-lg";
            submitButton.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                提交切割
            `;
            
            // 提交事件
            submitButton.addEventListener('click', submitCrop);
            
            // 添加按钮到容器
            submitContainer.appendChild(submitButton);
            
            // 添加到页面
            document.body.appendChild(submitContainer);
        }
        
        // 提交切割
        function submitCrop() {
            if (rectangles.length === 0) {
                alert('请先绘制至少一个矩形区域');
                return;
            }
            
            // 禁用提交按钮，防止重复提交
            const submitButton = document.getElementById('submit-button');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = `
                    <span class="loading loading-spinner"></span>
                    处理中...
                `;
            }
            
            // 准备提交数据
            const submitData = {
                image_id: currentImageId,
                rectangles: rectangles.map(rect => {
                    return {
                        id: rect.id,
                        class: rect.class || 'unknown',
                        confidence: rect.confidence || 1.0,
                        coords: rect.coords
                    };
                })
            };
            
            // 发送到后端进行切割
            fetch('/crop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(submitData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('处理失败');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // 显示结果对话框
                    showResultDialog(data);
                } else {
                    alert(`错误: ${data.error || '处理失败'}`);
                }
                
                // 重新启用提交按钮
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        提交切割
                    `;
                }
            })
            .catch(error => {
                console.error('提交错误:', error);
                alert(`错误: ${error.message}`);
                
                // 重新启用提交按钮
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        提交切割
                    `;
                }
            });
        }
        
        // 显示结果对话框
        function showResultDialog(data) {
            // 创建对话框背景
            const dialogBackground = document.createElement('div');
            dialogBackground.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center";
            
            // 创建对话框内容
            const dialog = document.createElement('div');
            dialog.className = "bg-base-100 p-6 rounded-box shadow-xl max-w-2xl w-full max-h-[90vh] overflow-auto";
            
            // 对话框标题
            const title = document.createElement('h2');
            title.className = "text-2xl font-bold mb-4 text-accent";
            title.textContent = "切割完成";
            
            // 对话框内容
            const content = document.createElement('div');
            content.className = "space-y-4";
            
            // 添加成功信息
            const message = document.createElement('p');
            message.className = "text-lg";
            message.textContent = data.message;
            content.appendChild(message);
            
            // 添加注释图片
            if (data.annotated_image_url) {
                const annotatedContainer = document.createElement('div');
                annotatedContainer.className = "mt-4";
                
                const annotatedTitle = document.createElement('h3');
                annotatedTitle.className = "text-lg font-semibold mb-2";
                annotatedTitle.textContent = "带标注的图像:";
                
                const annotatedImg = document.createElement('img');
                annotatedImg.src = data.annotated_image_url;
                annotatedImg.className = "w-full h-auto rounded-lg border border-base-300";
                annotatedImg.style.maxHeight = "400px";
                annotatedImg.style.objectFit = "contain";
                
                annotatedContainer.appendChild(annotatedTitle);
                annotatedContainer.appendChild(annotatedImg);
                content.appendChild(annotatedContainer);
            }
            
            // 添加下载链接
            if (data.zip_url) {
                const downloadContainer = document.createElement('div');
                downloadContainer.className = "mt-4 flex justify-center";
                
                const downloadLink = document.createElement('a');
                downloadLink.href = data.zip_url;
                downloadLink.className = "btn btn-primary";
                downloadLink.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    下载切割结果
                `;
                
                downloadContainer.appendChild(downloadLink);
                content.appendChild(downloadContainer);
            }
            
            // 关闭按钮
            const closeButton = document.createElement('button');
            closeButton.className = "btn btn-sm btn-circle absolute right-2 top-2";
            closeButton.innerHTML = "✕";
            closeButton.addEventListener('click', () => {
                document.body.removeChild(dialogBackground);
            });
            
            // 组装对话框
            dialog.appendChild(closeButton);
            dialog.appendChild(title);
            dialog.appendChild(content);
            dialogBackground.appendChild(dialog);
            
            // 显示对话框
            document.body.appendChild(dialogBackground);
        }

        // 设置Canvas尺寸
        function setupCanvas(img) {
            // 计算Canvas容器的可用宽度
            const containerWidth = canvasContainer.clientWidth - 40; // 减去一些边距
            const containerHeight = canvasContainer.clientHeight - 40;
            
            // 计算缩放比例，确保图片完全显示
            let scale = Math.min(
                containerWidth / img.width,
                containerHeight / img.height
            );
            
            // 计算显示尺寸
            const displayWidth = Math.round(img.width * scale);
            const displayHeight = Math.round(img.height * scale);
            
            // 存储缩放比例，用于后续坐标转换
            scaleX = displayWidth / originalImageWidth;
            scaleY = displayHeight / originalImageHeight;
            
            // 设置Canvas尺寸
            canvas.setWidth(displayWidth);
            canvas.setHeight(displayHeight);
            
            // 更新Canvas容器大小
            canvasWrapper.style.width = `${displayWidth}px`;
            canvasWrapper.style.height = `${displayHeight}px`;
            
            // 设置十字线尺寸
            crosshairH.style.width = displayWidth + 'px';
            crosshairV.style.height = displayHeight + 'px';
            
            // 重新渲染Canvas
            canvas.calcOffset();
            canvas.renderAll();
        }

        // 加载图片到Canvas
        function loadImageToCanvas(img) {
            // 清除当前的所有对象
            canvas.clear();
            
            // 创建背景图像
            fabric.Image.fromURL(img.src, (oImg) => {
                // 设置图像为背景
                canvas.setBackgroundImage(oImg, canvas.renderAll.bind(canvas), {
                    scaleX: canvas.width / img.width,
                    scaleY: canvas.height / img.height
                });
            });
        }

        // 启用矩形绘制
        function enableRectangleDrawing() {
            // 鼠标按下时开始绘制
            canvas.on('mouse:down', function(o) {
                const pointer = canvas.getPointer(o.e);
                isDrawing = true;
                startX = pointer.x;
                startY = pointer.y;
                
                // 生成单一颜色，但透明度不同
                const colorHue = getRandomColorHue();
                const fillColor = `hsla(${colorHue}, 80%, 60%, 0.3)`;
                const strokeColor = `hsla(${colorHue}, 80%, 60%, 0.8)`;
                
                // 创建一个新矩形
                currentRect = new fabric.Rect({
                    left: startX,
                    top: startY,
                    width: 0,
                    height: 0,
                    fill: fillColor,
                    stroke: strokeColor,
                    strokeWidth: 1,
                    selectable: false
                });
                
                canvas.add(currentRect);
                canvas.renderAll();
            });
            
            // 鼠标移动时调整矩形大小
            canvas.on('mouse:move', function(o) {
                const pointer = canvas.getPointer(o.e);
                
                // 更新十字线位置
                updateCrosshair(pointer);
                
                if (!isDrawing) return;
                
                let width = Math.abs(pointer.x - startX);
                let height = Math.abs(pointer.y - startY);
                
                // 计算矩形的左上角坐标
                let left = pointer.x < startX ? pointer.x : startX;
                let top = pointer.y < startY ? pointer.y : startY;
                
                // 更新矩形
                currentRect.set({
                    left: left,
                    top: top,
                    width: width,
                    height: height
                });
                
                canvas.renderAll();
            });
            
            // 鼠标释放时完成绘制
            canvas.on('mouse:up', function() {
                isDrawing = false;
                
                // 如果矩形太小，则删除它
                if (currentRect && (currentRect.width < 5 || currentRect.height < 5)) {
                    canvas.remove(currentRect);
                    currentRect = null;
                } else if (currentRect) {
                    // 计算新矩形的ID，确保连续
                    const newId = rectangles.length > 0 ? 
                                  Math.max(...rectangles.map(r => r.id)) + 1 : 1;
                    
                    // 保存矩形信息
                    const rectInfo = {
                        id: newId,
                        rect: currentRect,
                        coords: calculateCoordinates(currentRect)
                    };
                    rectangles.push(rectInfo);
                    
                    // 更新所有坐标信息
                    updateAllCoordinates();
                    
                    // 重置当前矩形
                    currentRect = null;
                }
            });
            
            // 鼠标进入canvas区域
            canvas.on('mouse:over', function() {
                crosshairH.style.display = 'block';
                crosshairV.style.display = 'block';
                coordinatesDisplay.style.display = 'block';
            });
            
            // 鼠标离开canvas区域
            canvas.on('mouse:out', function() {
                crosshairH.style.display = 'none';
                crosshairV.style.display = 'none';
                coordinatesDisplay.style.display = 'none';
            });
        }
        
        // 更新十字线位置和坐标显示
        function updateCrosshair(pointer) {
            if (!originalImageWidth || !originalImageHeight) return;
            
            // 获取canvas元素的位置
            const rect = canvas.wrapperEl.getBoundingClientRect();
            const x = pointer.x;
            const y = pointer.y;
            
            // 计算原图坐标
            const originalX = Math.round(x / scaleX);
            const originalY = Math.round(y / scaleY);
            
            // 设置十字线位置，确保它们完全贯穿画布
            crosshairH.style.top = y + 'px';
            crosshairH.style.left = '0';
            
            crosshairV.style.left = x + 'px';
            crosshairV.style.top = '0';
            
            // 更新坐标显示
            coordinatesDisplay.textContent = `X: ${originalX}, Y: ${originalY}`;
            coordinatesDisplay.style.left = (x + 10) + 'px';
            coordinatesDisplay.style.top = (y + 10) + 'px';
        }

        // 计算矩形的原图坐标
        function calculateCoordinates(rect) {
            const left = rect.left;
            const top = rect.top;
            const width = rect.width;
            const height = rect.height;
            
            // 计算原图坐标
            const originalLeft = Math.round(left / scaleX);
            const originalTop = Math.round(top / scaleY);
            const originalWidth = Math.round(width / scaleX);
            const originalHeight = Math.round(height / scaleY);
            const originalRight = originalLeft + originalWidth;
            const originalBottom = originalTop + originalHeight;
            
            // 确保坐标不超出原图范围
            const boundedLeft = Math.max(0, Math.min(originalLeft, originalImageWidth));
            const boundedTop = Math.max(0, Math.min(originalTop, originalImageHeight));
            const boundedRight = Math.max(0, Math.min(originalRight, originalImageWidth));
            const boundedBottom = Math.max(0, Math.min(originalBottom, originalImageHeight));
            
            // 返回四个角点坐标
            return {
                topLeft: { x: boundedLeft, y: boundedTop },
                topRight: { x: boundedRight, y: boundedTop },
                bottomLeft: { x: boundedLeft, y: boundedBottom },
                bottomRight: { x: boundedRight, y: boundedBottom }
            };
        }

        // 更新所有坐标信息显示
        function updateAllCoordinates() {
            // 清空坐标显示区域
            displayCoordinates.style.display = 'none'; // 隐藏不需要的坐标信息
            originalCoordinates.innerHTML = '';
            
            // 添加原图尺寸信息
            const sizeInfo = document.createElement('div');
            sizeInfo.className = "text-base-content mb-4 font-semibold";
            sizeInfo.textContent = `原图尺寸: ${originalImageWidth} × ${originalImageHeight}`;
            originalCoordinates.appendChild(sizeInfo);
            
            // 如果没有矩形，则显示初始信息
            if (rectangles.length === 0) {
                return;
            }
            
            // 创建矩形坐标信息容器
            const rectsContainer = document.createElement('div');
            rectsContainer.className = "space-y-4";
            
            // 为每个矩形创建一个坐标信息区域
            rectangles.forEach(rectInfo => {
                // 创建每个矩形的容器 - 使用DaisyUI的card组件
                const rectContainer = document.createElement('div');
                rectContainer.className = "card bg-base-200 shadow-sm";
                rectContainer.dataset.rectId = rectInfo.id;
                
                // 添加鼠标悬停事件 - 高亮对应的矩形
                rectContainer.addEventListener('mouseenter', () => {
                    // 保存原始样式，以便恢复
                    if (!rectInfo.rect._originalStyle) {
                        rectInfo.rect._originalStyle = {
                            strokeWidth: rectInfo.rect.strokeWidth,
                            stroke: rectInfo.rect.stroke,
                            fill: rectInfo.rect.fill
                        };
                    }
                    
                    // 高亮显示 - 加粗边框并增加填充亮度
                    const currentColor = rectInfo.rect.stroke;
                    let highlightStroke, highlightFill;
                    
                    if (currentColor.includes('hsla')) {
                        // 提取色相值
                        const hueMatch = currentColor.match(/hsla\((\d+)/);
                        const hue = hueMatch ? hueMatch[1] : "0";
                        
                        // 创建高亮颜色 - 边框为实色，填充为半透明
                        highlightStroke = `hsla(${hue}, 100%, 50%, 1)`;
                        highlightFill = `hsla(${hue}, 100%, 60%, 0.5)`;
                    } else {
                        // 如果是其他颜色格式则使用明亮的红色
                        highlightStroke = 'rgba(255, 0, 0, 1)';
                        highlightFill = 'rgba(255, 0, 0, 0.5)';
                    }
                    
                    // 应用高亮样式
                    rectInfo.rect.set({
                        strokeWidth: 2,
                        stroke: highlightStroke,
                        fill: highlightFill
                    });
                    
                    // 确保矩形在顶层显示
                    canvas.bringToFront(rectInfo.rect);
                    canvas.renderAll();
                });
                
                // 添加鼠标离开事件 - 恢复矩形样式
                rectContainer.addEventListener('mouseleave', () => {
                    // 恢复原始样式
                    if (rectInfo.rect._originalStyle) {
                        rectInfo.rect.set({
                            strokeWidth: rectInfo.rect._originalStyle.strokeWidth,
                            stroke: rectInfo.rect._originalStyle.stroke,
                            fill: rectInfo.rect._originalStyle.fill
                        });
                        
                        canvas.renderAll();
                    }
                });
                
                // 创建卡片内容区
                const cardBody = document.createElement('div');
                cardBody.className = "card-body p-4";
                
                // 创建标题，包含删除按钮
                const headerContainer = document.createElement('div');
                headerContainer.className = "card-title text-sm justify-between items-center mb-2";
                
                // 标题文本与颜色指示器
                const titleElement = document.createElement('div');
                titleElement.className = "flex items-center";
                
                // 颜色指示器
                const colorIndicator = document.createElement('div');
                colorIndicator.className = "w-4 h-3 mr-2 rounded";
                colorIndicator.style.backgroundColor = rectInfo.rect.stroke;
                
                // 标题文本
                const titleText = document.createElement('span');
                titleText.textContent = `矩形 #${rectInfo.id}`;
                
                titleElement.appendChild(colorIndicator);
                titleElement.appendChild(titleText);
                
                // 删除按钮
                const deleteButton = document.createElement('button');
                deleteButton.className = "btn btn-xs btn-error btn-outline";
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                `;
                
                // 删除按钮事件
                deleteButton.addEventListener('click', () => {
                    canvas.remove(rectInfo.rect);
                    // 删除当前矩形
                    rectangles = rectangles.filter(r => r.id !== rectInfo.id);
                    // 重新编号
                    rectangles.forEach((rect, index) => {
                        rect.id = index + 1;
                    });
                    // 更新所有坐标信息
                    updateAllCoordinates();
                });
                
                headerContainer.appendChild(titleElement);
                headerContainer.appendChild(deleteButton);
                
                // 创建格式化JSON字符串
                const jsonElement = document.createElement('pre');
                jsonElement.className = "text-xs bg-base-300 p-3 rounded overflow-auto";
                jsonElement.textContent = JSON.stringify(rectInfo.coords, null, 2);
                
                // 将标题和JSON添加到卡片内容区
                cardBody.appendChild(headerContainer);
                cardBody.appendChild(jsonElement);
                
                // 将卡片内容区添加到矩形容器
                rectContainer.appendChild(cardBody);
                
                // 将矩形容器添加到主容器
                rectsContainer.appendChild(rectContainer);
            });
            
            // 将所有矩形信息添加到原图坐标区域
            originalCoordinates.appendChild(rectsContainer);
        }

        // 生成随机accent色调的颜色
        function getRandomAccentColor(alpha = 1) {
            // 使用accent色系
            const hue = getRandomColorHue();
            return `hsla(${hue}, 80%, 60%, ${alpha})`;
        }
        
        // 获取不重复的颜色色相
        function getRandomColorHue() {
            // 如果所有颜色都已使用，则重置颜色池
            if (usedColors.length >= colorPool.length) {
                usedColors = [];
            }
            
            // 找出可用的颜色
            const availableColors = colorPool.filter(color => !usedColors.includes(color));
            
            // 随机选择一个可用颜色
            const randomIndex = Math.floor(Math.random() * availableColors.length);
            const selectedHue = availableColors[randomIndex];
            
            // 标记为已使用
            usedColors.push(selectedHue);
            
            return selectedHue;
        }

        // 窗口大小改变时重新计算Canvas尺寸
        window.addEventListener('resize', debounce(function() {
            if (originalImageWidth > 0 && originalImageHeight > 0) {
                const img = new Image();
                img.onload = () => {
                    // 保存当前矩形的原始坐标
                    const originalRects = rectangles.map(rectInfo => {
                        const rect = rectInfo.rect;
                        return {
                            id: rectInfo.id,
                            originalLeft: rect.left / scaleX,
                            originalTop: rect.top / scaleY,
                            originalWidth: rect.width / scaleX,
                            originalHeight: rect.height / scaleY,
                            fill: rect.fill,
                            stroke: rect.stroke
                        };
                    });
                    
                    // 更新Canvas尺寸
                    setupCanvas(img);
                    loadImageToCanvas(img);
                    
                    // 更新十字线尺寸
                    crosshairH.style.width = canvas.width + 'px';
                    crosshairV.style.height = canvas.height + 'px';
                    
                    // 重建所有矩形
                    rectangles = [];
                    originalRects.forEach(origRect => {
                        // 创建一个新矩形
                        const newRect = new fabric.Rect({
                            left: origRect.originalLeft * scaleX,
                            top: origRect.originalTop * scaleY,
                            width: origRect.originalWidth * scaleX,
                            height: origRect.originalHeight * scaleY,
                            fill: origRect.fill,
                            stroke: origRect.stroke,
                            strokeWidth: 1,
                            selectable: false
                        });
                        
                        canvas.add(newRect);
                        
                        // 保存矩形信息
                        rectangles.push({
                            id: origRect.id,
                            rect: newRect,
                            coords: calculateCoordinates(newRect)
                        });
                    });
                    
                    canvas.renderAll();
                    updateAllCoordinates();
                };
                img.src = canvas.backgroundImage.getSrc();
            }
        }, 250));

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
    </script>
</body>
</html>
